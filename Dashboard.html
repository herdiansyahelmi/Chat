<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Alfamind</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:Arial,sans-serif;background:#f5f5f5;min-height:100vh}
        .sidebar{position:fixed;left:0;top:0;width:220px;height:100vh;background:#1a1a2e;color:#fff;padding:20px 0}
        .sidebar .logo{font-size:20px;font-weight:900;font-style:italic;color:#e30613;padding:0 20px 20px;border-bottom:1px solid #2a2a4e}
        .sidebar .menu{list-style:none;margin-top:20px}
        .sidebar .menu li{padding:12px 20px;cursor:pointer;font-size:14px;transition:.2s;display:flex;align-items:center;gap:10px}
        .sidebar .menu li:hover,.sidebar .menu li.active{background:#2a2a4e;border-left:3px solid #e30613}
        .main{margin-left:220px;padding:20px}
        .topbar{background:#fff;padding:16px 24px;border-radius:12px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 3px rgba(0,0,0,.08)}
        .topbar h2{font-size:18px;color:#333}
        .btn{padding:10px 20px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
        .btn-primary{background:#e30613;color:#fff}
        .btn-primary:hover{background:#c70511}
        .btn-danger{background:#ff4757;color:#fff}
        .btn-danger:hover{background:#e03040}
        .btn-sm{padding:6px 12px;font-size:12px}
        .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:20px}
        .card h3{font-size:15px;color:#333;margin-bottom:16px}
        table{width:100%;border-collapse:collapse}
        th,td{padding:10px 12px;text-align:left;font-size:13px;border-bottom:1px solid #eee}
        th{background:#f9f9f9;font-weight:600;color:#666}
        td{color:#333}
        .badge{padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
        .badge-active{background:#e8f5e9;color:#2e7d32}
        .badge-inactive{background:#fce4ec;color:#c62828}
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:center}
        .modal-overlay.show{display:flex}
        .modal{background:#fff;border-radius:12px;padding:24px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto}
        .modal h3{font-size:16px;margin-bottom:16px;color:#333}
        .form-group{margin-bottom:14px}
        .form-group label{display:block;font-size:13px;color:#666;margin-bottom:6px}
        .form-group input,.form-group textarea,.form-group select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:13px;outline:none}
        .form-group input:focus,.form-group textarea:focus{border-color:#e30613}
        .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
        .btn-cancel{background:#eee;color:#333}
        .btn-cancel:hover{background:#ddd}
        .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px}
        .stat-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.08);text-align:center}
        .stat-card .num{font-size:28px;font-weight:bold;color:#e30613}
        .stat-card .label{font-size:12px;color:#999;margin-top:4px}
        .member-tag{display:inline-block;background:#f0f0f0;padding:4px 10px;border-radius:12px;font-size:12px;margin:2px;color:#333}
        .member-tag .remove{color:#e30613;cursor:pointer;margin-left:4px;font-weight:bold}
    </style>
</head>
<body>
<div class="sidebar">
    <div class="logo">Alfamind</div>
    <ul class="menu">
        <li class="active" onclick="showPage('dashboard')">üìä Dashboard</li>
        <li onclick="showPage('groups')">üí¨ Grup Chat</li>
        <li onclick="showPage('users')">üë• Data User</li>
        <li onclick="logout()">üö™ Logout</li>
    </ul>
</div>
<div class="main">
    <!-- Dashboard -->
    <div id="page-dashboard">
        <div class="topbar"><h2>Dashboard</h2></div>
        <div class="stats">
            <div class="stat-card"><div class="num" id="totalGroups">0</div><div class="label">Total Grup</div></div>
            <div class="stat-card"><div class="num" id="totalUsers">0</div><div class="label">Total User</div></div>
            <div class="stat-card"><div class="num" id="totalMessages">0</div><div class="label">Total Pesan</div></div>
        </div>
    </div>

    <!-- Grup Chat -->
    <div id="page-groups" style="display:none">
        <div class="topbar"><h2>Manage Grup Chat</h2><button class="btn btn-primary" onclick="openModal('addGroup')">+ Buat Grup</button></div>
        <div class="card">
            <table>
                <thead><tr><th>Nama Grup</th><th>Deskripsi</th><th>Member</th><th>Status</th><th>Aksi</th></tr></thead>
                <tbody id="groupTable"></tbody>
            </table>
        </div>
    </div>

    <!-- Data User -->
    <div id="page-users" style="display:none">
        <div class="topbar"><h2>Data User</h2></div>
        <div class="card">
            <table>
                <thead><tr><th>Member ID</th><th>Nama</th><th>No. Telp</th></tr></thead>
                <tbody id="userTable"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Buat Grup -->
<div class="modal-overlay" id="modal-addGroup">
    <div class="modal">
        <h3>Buat Grup Baru</h3>
        <div class="form-group"><label>Nama Grup</label><input type="text" id="inputGrupName"></div>
        <div class="form-group"><label>Deskripsi</label><textarea id="inputGrupDesc" rows="3"></textarea></div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal('addGroup')">Batal</button>
            <button class="btn btn-primary" onclick="createGroup()">Simpan</button>
        </div>
    </div>
</div>

<!-- Modal Manage Member -->
<div class="modal-overlay" id="modal-members">
    <div class="modal">
        <h3>Manage Member - <span id="memberGrupName"></span></h3>
        <div id="memberList" style="margin-bottom:16px"></div>
        <div class="form-group">
            <label>Tambah Member</label>
            <select id="selectUser"><option value="">Pilih user...</option></select>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeModal('members')">Tutup</button>
            <button class="btn btn-primary" onclick="addMember()">Tambah</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
var SUPABASE_URL='https://xobpjlcxioldrttoietl.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvYnBqbGN4aW9sZHJ0dG9pZXRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NTU2NTUsImV4cCI6MjA4NzEzMTY1NX0.GNjqP3Zv4V1B9qsFhscywc_Qor4SJ_4hy3-uG27Vm0E';
var sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

var allUsers=[];
var currentGroupId=null;

// Page navigation
function showPage(page){
    document.querySelectorAll('[id^="page-"]').forEach(function(el){el.style.display='none';});
    document.getElementById('page-'+page).style.display='block';
    document.querySelectorAll('.menu li').forEach(function(el){el.classList.remove('active');});
    event.target.classList.add('active');
    if(page==='groups') loadGroups();
    if(page==='users') loadUsers();
    if(page==='dashboard') loadStats();
}

function openModal(id){document.getElementById('modal-'+id).classList.add('show');}
function closeModal(id){document.getElementById('modal-'+id).classList.remove('show');}

// Load stats
async function loadStats(){
    var {count:gc}=await sb.from('chat_groups').select('*',{count:'exact',head:true});
    var {count:uc}=await sb.from('data_user').select('*',{count:'exact',head:true});
    var {count:mc}=await sb.from('chat_messages').select('*',{count:'exact',head:true});
    document.getElementById('totalGroups').textContent=gc||0;
    document.getElementById('totalUsers').textContent=uc||0;
    document.getElementById('totalMessages').textContent=mc||0;
}

// Load groups
async function loadGroups(){
    var {data:groups}=await sb.from('chat_groups').select('*').order('created_at',{ascending:false});
    var tbody=document.getElementById('groupTable');
    if(!groups||groups.length===0){tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#999">Belum ada grup</td></tr>';return;}
    var html='';
    for(var i=0;i<groups.length;i++){
        var g=groups[i];
        var {count}=await sb.from('chat_group_members').select('*',{count:'exact',head:true}).eq('group_id',g.id);
        html+='<tr>';
        html+='<td><strong>'+g.nama_grup+'</strong></td>';
        html+='<td>'+(g.deskripsi||'-')+'</td>';
        html+='<td>'+(count||0)+' orang</td>';
        html+='<td><span class="badge '+(g.is_active?'badge-active':'badge-inactive')+'">'+(g.is_active?'Aktif':'Nonaktif')+'</span></td>';
        html+='<td>';
        html+='<button class="btn btn-primary btn-sm" onclick="openMembers(\''+g.id+'\',\''+g.nama_grup+'\')">üë• Member</button> ';
        html+='<button class="btn btn-danger btn-sm" onclick="deleteGroup(\''+g.id+'\')">üóëÔ∏è</button>';
        html+='</td></tr>';
    }
    tbody.innerHTML=html;
}

// Create group
async function createGroup(){
    var name=document.getElementById('inputGrupName').value.trim();
    var desc=document.getElementById('inputGrupDesc').value.trim();
    if(!name){alert('Nama grup harus diisi!');return;}
    await sb.from('chat_groups').insert({nama_grup:name,deskripsi:desc});
    document.getElementById('inputGrupName').value='';
    document.getElementById('inputGrupDesc').value='';
    closeModal('addGroup');
    loadGroups();
    loadStats();
}

// Delete group
async function deleteGroup(id){
    if(!confirm('Hapus grup ini? Semua pesan akan ikut terhapus.'))return;
    await sb.from('chat_groups').delete().eq('id',id);
    loadGroups();
    loadStats();
}

// Open members modal
async function openMembers(groupId,groupName){
    currentGroupId=groupId;
    document.getElementById('memberGrupName').textContent=groupName;
    await loadAllUsers();
    await loadMembers();
    openModal('members');
}

async function loadAllUsers(){
    var {data}=await sb.from('data_user').select('*');
    allUsers=data||[];
}

async function loadMembers(){
    var {data:members}=await sb.from('chat_group_members').select('member_id, data_user(nama, "memberId")').eq('group_id',currentGroupId);
    var container=document.getElementById('memberList');
    if(!members||members.length===0){container.innerHTML='<p style="color:#999;font-size:13px">Belum ada member</p>';updateSelect(members);return;}
    var html='';
    members.forEach(function(m){
        var nama=m.data_user?m.data_user.nama:'User '+m.member_id;
        html+='<span class="member-tag">'+nama+' <span class="remove" onclick="removeMember('+m.member_id+')">&times;</span></span>';
    });
    container.innerHTML=html;
    updateSelect(members);
}

function updateSelect(members){
    var select=document.getElementById('selectUser');
    var memberIds=(members||[]).map(function(m){return m.member_id;});
    var html='<option value="">Pilih user...</option>';
    allUsers.forEach(function(u){
        if(memberIds.indexOf(u.memberId)===-1){
            html+='<option value="'+u.memberId+'">'+u.nama+' ('+u.memberId+')</option>';
        }
    });
    select.innerHTML=html;
}

async function addMember(){
    var memberId=document.getElementById('selectUser').value;
    if(!memberId){alert('Pilih user dulu!');return;}
    await sb.from('chat_group_members').insert({group_id:currentGroupId,member_id:parseInt(memberId)});
    loadMembers();
    loadGroups();
}

async function removeMember(memberId){
    if(!confirm('Hapus member ini dari grup?'))return;
    await sb.from('chat_group_members').delete().eq('group_id',currentGroupId).eq('member_id',memberId);
    loadMembers();
    loadGroups();
}

// Load users
async function loadUsers(){
    var {data:users}=await sb.from('data_user').select('*');
    var tbody=document.getElementById('userTable');
    if(!users||users.length===0){tbody.innerHTML='<tr><td colspan="3" style="text-align:center;color:#999">Tidak ada data</td></tr>';return;}
    var html='';
    users.forEach(function(u){
        html+='<tr><td>'+u.memberId+'</td><td>'+u.nama+'</td><td>'+(u.noTlp||'-')+'</td></tr>';
    });
    tbody.innerHTML=html;
}

function logout(){
    if(confirm('Logout?')){localStorage.removeItem('admin');window.location.href='LoginAdmin.html';}
}

var admin=JSON.parse(localStorage.getItem('admin'));
if(!admin) window.location.href='LoginAdmin.html';
loadStats();
</script>
</body>
</html>
